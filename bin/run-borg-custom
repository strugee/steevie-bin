#!/bin/sh

# TODO DRY this up with run-borg
# TODO strip leading / characters from $@

set -eu

. $(dirname $0)/../lib/run-borg/functions.sh

ARGSTR='[-w] [-s] FILE...'

ensure_args "$ARGSTR" $@

if [ $1 = '-w' ]; then
	DOTLOCK_ARGS="-r -1"
	shift
	ensure_args "$ARGSTR" $@
else
	DOTLOCK_ARGS=""
fi

if [ $1 = '-s' ]; then
	BORG_FLAGS='--read-special'
	shift
	ensure_args "$ARGSTR" $@
else
	BORG_FLAGS=''
fi

test_is_root

lockfile_acquire

BORG_TAG="customrun-$1"
shift

# TODO trap crashes and run gc()

# Garbage-collect old staging snapshots in case we crashed last time
gc_if_needed

# Freeze a view of the filesystem at /media/borg-stage so Borg backups are atomic
freeze_fs

cd /media/borg-stage

borg create $BORG_FLAGS --progress --stats --compression auto,lzma,6 \
--exclude root/.gdfuse/default/cache \
--exclude root/.cache \
--exclude home/*/.cache \
--exclude var/cache \
--exclude var/backups \
--exclude var/tmp \
--exclude var/log \
/media/gdrive/borg::steevie-$(date +%F-%H:%M-%a-%s)-$BORG_TAG \
$@

# Need to not be in /media/borg-stage so that it can be unmounted
cd - >/dev/null

gc

lockfile_release
