#!/bin/sh
# TODO: improve this to not stop Apache when `letsencrypt renew --domain` works
# TODO: write to a logfile

cert_identity() {
	sha256sum /etc/letsencrypt/live/$1/cert.pem | cut -d' ' -f1
}

if [ $(id -u) -ne 0 ]; then
	echo 'renew-letsencrypt: not invoked as root; bailing'
	exit 1
fi

# Internal

if [ "$1" = _pre_hook ]; then
	echo "Stopping Apache, pump.io and Sandstorm."
	if systemctl stop apache2 && systemctl stop pump.io@mongodb && systemctl stop sandstorm; then
		exit 0
	else
		echo "Stopping services failed. This probably indicates a serious misconfiguration."
		echo "Mailing root."
		echo "Execution of \`systemctl stop apache2 && systemctl stop pump.io@mongodb && systemctl stop sandstorm\` failed while renewing Let's Encrypt certificates.\n\nThis probably indicates a serious misconfiguration. Please investigate as soon as possible.\n\n - crond" | mail -s "renew-letsencrypt: failed to stop Apache, pump.io or Sandstorm" root
		exit 1
	fi
fi

if [ "$1" = _post_hook ]; then
	FAILED=0
	echo "Unconditionally restarting Apache."
	systemctl start apache2 || FAILED=1
	echo "Unconditionally restarting pump.io."
	# XXX uncomment when I unmask pump.io@mongodb
	systemctl start pump.io@mongodb #|| FAILED=1
	echo "Unconditionally restarting Sandstorm."
	systemctl start sandstorm || FAILED=1

	exit $FAILED
fi

MAIN_CERT_UNIQUEID=$(cert_identity strugee.net)
MAIL_CERT_UNIQUEID=$(cert_identity mail.strugee.net)
ZNC_CERT_UNIQUEID=$(cert_identity znc.strugee.net)

etckeeper commit "Commit changes prior to renew-letsencrypt run"

echo "Invoking Let's Encrypt."
if letsencrypt renew --noninteractive --pre-hook "$0 _pre_hook" --post-hook "$0 _post_hook"; then
	echo "Renewal succeeded."
else
	echo "Failed to renew some certificates. Mailing root."
	echo "Execution of \`letsencrypt renew\` failed while renewing Let's Encrypt certificates.\n\nThis may indicate a misconfiguration. Please investigate as soon as possible.\n\n - crond" | mail -s "renew-letsencrypt: failed to execute \`letsencrypt renew\`" root
fi

# TODO: consider migrating this to --renew-hook

if [ $MAIN_CERT_UNIQUEID != $(cert_identity strugee.net) ]; then
	echo "Rebuilding ejabberd certificates due to updated certificate."
	generate-ejabberd-bundle
	echo "Rebuilding Cockpit certificates due to updated certificate."
	generate-cockpit-bundle
	echo "Restarting ejabberd due to updated certificate."
	systemctl restart ejabberd
	echo "Restarting Cockpit due to updated certificate."
	systemctl restart cockpit
fi

if [ $MAIL_CERT_UNIQUEID != $(cert_identity mail.strugee.net) ]; then
	echo "Restarting Postfix due to updated certificate."
	systemctl restart postfix
	echo "Restarting Dovecot due to updated certificate."
	systemctl restart dovecot
fi

if [ $ZNC_CERT_UNIQUEID != $(cert_identity znc.strugee.net) ]; then
	echo "Rebuilding ZNC certificates due to updated certificate."
	generate-znc-bundle
	echo "Not restarting ZNC because client connections will cause a certificate reload."
fi

etckeeper commit "Renew and rebuild TLS certificates"
