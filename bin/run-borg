#!/bin/sh

# TODO make sure this handles LXD datasets right?

set -eu

CHRONIC=false
test $(ps -o comm= $PPID) = chronic && CHRONIC=true

SOFTERR_STREAM=2
$CHRONIC && SOFTERR_STREAM=1
SOFTERR_EXITCODE=1
$CHRONIC && SOFTERR_EXITCODE=0

if [ $(id -u) != 0 ]; then
	echo $(basename $0): need to be root >&2
	exit 1
fi

if ! dotlockfile -pr0 /var/lock/run-borg.lock; then
	echo $(basename $0): failed to acquire lockfile >&$SOFTERR_STREAM
	exit $SOFTERR_EXITCODE
fi

# TODO trap crashes and run this

gc() {
	mountpoint -q /media/borg-stage && umount -R /media/borg-stage
	# For some reason there's a weird alternate empty dataset mount underneath everything that doesn't unmount the first time around
	mountpoint -q /media/borg-stage && umount -R /media/borg-stage
	zfs destroy -r rpool@borg-stage
}

# Garbage-collect old staging snapshots in case we crashed last time
zfs list -d1 rpool@borg-stage >/dev/null 2>&1 && gc

# Freeze a view of the filesystem so Borg backups are atomic
zfs snapshot -r rpool@borg-stage
mkdir -p /media/borg-stage
zfs-mount-snapshots borg-stage /media/borg-stage

# It takes a *long* time to walk system directories so we only do so when
# triggered to do so by a dpkg postrun hook.
# Note that we always walk /usr/local because modifying that won't trigger
# the dpkg hook. Ditto with /usr/lib/node_modules and npm. /boot isn't there
# either because of tools like update-initramfs.
SYSTEM_DIRS='usr/local usr/lib/node_modules'
BORG_TAG=''
if test -e /var/local/borg-trigger-system-backup; then
	SYSTEM_DIRS='bin lib lib64 sbin usr'
	BORG_TAG='-withsystem'
fi

cd /media/borg-stage

borg create --progress --stats --compression auto,lzma,6 \
--exclude root/.gdfuse/default/cache \
--exclude root/.cache \
--exclude home/*/.cache \
--exclude var/cache \
--exclude var/backups \
--exclude var/tmp \
--exclude var/log \
/media/gdrive/borg::steevie-$(date +%F-%H:%M-%a-%s)$BORG_TAG \
etc \
home \
srv \
root \
var \
opt \
/boot \
lost+found \
vmlinuz* \
initrd.img* \
snap \
lxd \
$SYSTEM_DIRS

# Need to not be in /media/borg-stage so that it can be unmounted
cd - >/dev/null

gc

rm -f /var/local/borg-trigger-system-backup

dotlockfile -u /var/lock/run-borg.lock
